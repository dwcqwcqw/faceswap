<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç®¡ç†å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .task-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status-processing {
            background-color: #e3f2fd;
        }
        .status-completed {
            background-color: #e8f5e8;
        }
        .status-failed {
            background-color: #ffebee;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #2196f3;
            color: white;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        .btn-success {
            background-color: #4caf50;
            color: white;
        }
        .log {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ä»»åŠ¡ç®¡ç†å™¨æµ‹è¯•</h1>
    
    <div>
        <h2>æ“ä½œ</h2>
        <button class="btn-primary" onclick="addTestTask()">æ·»åŠ æµ‹è¯•ä»»åŠ¡</button>
        <button class="btn-success" onclick="checkTaskHistory()">æ£€æŸ¥ä»»åŠ¡å†å²</button>
        <button class="btn-danger" onclick="clearTestTasks()">æ¸…ç†æµ‹è¯•ä»»åŠ¡</button>
        <button class="btn-primary" onclick="simulateTaskUpdate()">æ¨¡æ‹Ÿä»»åŠ¡æ›´æ–°</button>
    </div>

    <div>
        <h2>ä»»åŠ¡å†å² (localStorage)</h2>
        <div id="taskHistory"></div>
    </div>

    <div>
        <h2>æ´»è·ƒä»»åŠ¡ (TaskManager)</h2>
        <div id="activeTasks"></div>
    </div>

    <div>
        <h2>æ—¥å¿—</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logContent = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }

        // æ¨¡æ‹Ÿä»»åŠ¡å†å²ç®¡ç†å™¨
        class TaskHistoryManager {
            constructor() {
                this.STORAGE_KEY = 'faceswap_task_history';
            }

            getHistory() {
                try {
                    const stored = localStorage.getItem(this.STORAGE_KEY);
                    if (!stored) return [];
                    
                    const history = JSON.parse(stored);
                    return history.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
                } catch (error) {
                    log('Failed to load task history: ' + error.message);
                    return [];
                }
            }

            addTask(task) {
                try {
                    const history = this.getHistory();
                    
                    const existingIndex = history.findIndex(item => item.id === task.id);
                    
                    if (existingIndex >= 0) {
                        history[existingIndex] = task;
                    } else {
                        history.unshift(task);
                        
                        if (history.length > 50) {
                            history.splice(50);
                        }
                    }
                    
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(history));
                    log(`âœ… ä»»åŠ¡å·²æ·»åŠ åˆ°å†å²: ${task.id}`);
                } catch (error) {
                    log('Failed to save task to history: ' + error.message);
                }
            }

            getActiveTasks() {
                return this.getHistory().filter(task => 
                    task.status === 'pending' || task.status === 'processing'
                );
            }

            updateTask(taskId, updates) {
                try {
                    const history = this.getHistory();
                    const taskIndex = history.findIndex(item => item.id === taskId);
                    
                    if (taskIndex >= 0) {
                        history[taskIndex] = { ...history[taskIndex], ...updates };
                        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(history));
                        log(`âœ… ä»»åŠ¡å·²æ›´æ–°: ${taskId}`);
                    }
                } catch (error) {
                    log('Failed to update task history: ' + error.message);
                }
            }
        }

        const taskHistory = new TaskHistoryManager();

        function addTestTask() {
            const testTask = {
                id: 'test_video_task_' + Date.now(),
                type: 'video',
                title: 'æµ‹è¯•è§†é¢‘æ¢è„¸ä»»åŠ¡',
                status: 'processing',
                progress: Math.floor(Math.random() * 100),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                files: {
                    source: 'test_face.jpg',
                    target: 'test_video.mp4'
                }
            };

            taskHistory.addTask(testTask);
            log(`ğŸ†• æ·»åŠ æµ‹è¯•ä»»åŠ¡: ${testTask.id} (${testTask.status}, ${testTask.progress}%)`);
            updateDisplay();
        }

        function checkTaskHistory() {
            const history = taskHistory.getHistory();
            const activeTasks = taskHistory.getActiveTasks();
            
            log(`ğŸ“‹ ä»»åŠ¡å†å²æ€»æ•°: ${history.length}`);
            log(`ğŸ”„ æ´»è·ƒä»»åŠ¡æ•°: ${activeTasks.length}`);
            
            activeTasks.forEach(task => {
                log(`  - ${task.id}: ${task.status} (${task.progress}%)`);
            });
            
            updateDisplay();
        }

        function clearTestTasks() {
            const history = taskHistory.getHistory();
            const filtered = history.filter(task => !task.id.startsWith('test_'));
            localStorage.setItem('faceswap_task_history', JSON.stringify(filtered));
            log(`ğŸ§¹ å·²æ¸…ç†æµ‹è¯•ä»»åŠ¡ï¼Œå‰©ä½™: ${filtered.length}`);
            updateDisplay();
        }

        function simulateTaskUpdate() {
            const activeTasks = taskHistory.getActiveTasks();
            if (activeTasks.length === 0) {
                log('âš ï¸ æ²¡æœ‰æ´»è·ƒä»»åŠ¡å¯æ›´æ–°');
                return;
            }

            const task = activeTasks[0];
            const newProgress = Math.min(100, task.progress + Math.floor(Math.random() * 20));
            const newStatus = newProgress >= 100 ? 'completed' : 'processing';

            taskHistory.updateTask(task.id, {
                progress: newProgress,
                status: newStatus,
                updated_at: new Date().toISOString()
            });

            log(`ğŸ”„ æ›´æ–°ä»»åŠ¡ ${task.id}: ${newStatus} (${newProgress}%)`);
            updateDisplay();
        }

        function updateDisplay() {
            // æ›´æ–°ä»»åŠ¡å†å²æ˜¾ç¤º
            const history = taskHistory.getHistory();
            const historyHtml = history.map(task => `
                <div class="task-item status-${task.status}">
                    <strong>${task.title}</strong> (${task.id})<br>
                    çŠ¶æ€: ${task.status} | è¿›åº¦: ${task.progress}% | ç±»å‹: ${task.type}<br>
                    åˆ›å»º: ${new Date(task.created_at).toLocaleString()}<br>
                    æ›´æ–°: ${new Date(task.updated_at).toLocaleString()}
                </div>
            `).join('');
            document.getElementById('taskHistory').innerHTML = historyHtml || '<p>æš‚æ— ä»»åŠ¡å†å²</p>';

            // æ›´æ–°æ´»è·ƒä»»åŠ¡æ˜¾ç¤º
            const activeTasks = taskHistory.getActiveTasks();
            const activeHtml = activeTasks.map(task => `
                <div class="task-item status-${task.status}">
                    <strong>${task.title}</strong> (${task.id})<br>
                    çŠ¶æ€: ${task.status} | è¿›åº¦: ${task.progress}%<br>
                    <button class="btn-danger" onclick="cancelTask('${task.id}')">å–æ¶ˆä»»åŠ¡</button>
                </div>
            `).join('');
            document.getElementById('activeTasks').innerHTML = activeHtml || '<p>æš‚æ— æ´»è·ƒä»»åŠ¡</p>';
        }

        function cancelTask(taskId) {
            taskHistory.updateTask(taskId, {
                status: 'failed',
                error_message: 'ç”¨æˆ·æ‰‹åŠ¨å–æ¶ˆ',
                updated_at: new Date().toISOString()
            });
            log(`ğŸ›‘ å–æ¶ˆä»»åŠ¡: ${taskId}`);
            updateDisplay();
        }

        // åˆå§‹åŒ–æ˜¾ç¤º
        log('ğŸš€ ä»»åŠ¡ç®¡ç†å™¨æµ‹è¯•é¡µé¢å·²åŠ è½½');
        updateDisplay();

        // å®šæœŸæ›´æ–°æ˜¾ç¤º
        setInterval(updateDisplay, 2000);
    </script>
</body>
</html> 